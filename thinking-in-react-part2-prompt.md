# React の思想を考える - 第 2 回 React のコア思想である 純粋関数性


ここからは、React 特有の思想について解説していく。

- 要素を生成する仕組み に 「純粋関数性」 を強く推奨する 関数型の思想
  - 宣言的 UI に渡す 要素 を 生成する関数 を コンポーネント と呼ぶ
    - 以後、React の要素は明示的に 「React 要素」 と呼ぶ
    - React では、このコンポーネントを
    - クラスではなく 関数 として定義することを推奨している
    - 関数として定義されたコンポーネント = 関数コンポーネント
    - そして 関数コンポーネントの 実装 において、
    - 関数型プログラミング の 概念 や パターン を 多く取り入れている
  - 具体的には、関数コンポーネントに対して、以下の特性を持つように設計することを要求している
    - A. 同じ入力に対して同じ出力を返す関数
      - つまり、入力値 以外の 外部の値から読み取りを行わない関数
    - B. 関数の実行で外部の値を変更しない関数
      - つまり、戻り値 以外の 外部の値に書き込みを行わない関数
  - この A/B の両方を満たす関数 = 純粋関数 とし、
    - 関数コンポーネントは 純粋関数 であることを強く推奨している
  - UI を記述する React 要素を生成する 関数コンポーネントが
    - f(...) = React 要素 という純粋関数性 を 保つように設計する、というのは
    - React の 真髄とも言える重要な設計思想である
    - この設計思想があることの大きな利点は 2 つある
    - 1. 責務の分離
      - 従来の UI フレームワークでは、
        - 純粋な UI の記述
        - 外部システムとのやり取り
      - の 2 つの責務が混在しがちだった
      - React では この 2 つの責務を明確に分離する設計を要求することで
        - 開発者が 強制的に これらの責務の混在しないコードを書くことを促す
        - そのため、コード品質が一定に保たれ、無秩序なコードが減る (理論上は)
      - これは開発者から見て大きな利点となる
        - 余談:
          - しかし、この思想はしばしば
          - 「React は 過度に複雑である」という批判の的にもなる
          - むずかしいところ
    - 2. 純粋関数性 を前提とした 最適化 や 並列処理
      - React 内部では、関数コンポーネントが純粋関数性を持つことを前提に
        - 実行の並列化 (React 18 の Concurrent Features による 並列レンダリング など)
        - 関数コンポーネントの 実行一時停止・再開による ユーザ操作への 応答性向上
        - パフォーマンスの最適化 (React Compiler による メモ化の自動化 など)
        - 関数コンポーネントの 実行停止 (サスペンド) による ロード画面表示
      - を 行うことができる
      - これは React 自体の性能向上や ユーザ体験の向上 に寄与する
    - React は 今後も 純粋関数性を前提とした 最適化 や 並列処理 の技術を積極的に導入していく予定である
    - そのため、React の 最適化 や 並列処理 の恩恵を最大限に受けるためにも
    - 関数コンポーネントは 純粋関数性 を持つように設計することが重要である
    - 純粋関数性を保つことは、開発者・React 双方にとって 大きな利益をもたらす
  - A/B の詳細を見ていく
    - A. 同じ入力に対して同じ出力を返す関数
      - 同じ入力値 state, props, context の組み合わせに対しては、常に同じ React 要素 を返すような関数
      - 擬似的な式で表現すると、
        - f(state, props, context) = React 要素
        - props, state もまとめて状態として考えることもできるため、
        - 簡単に f(state) = UI と表現されることもある
      - また、 React 公式はこの性質を「idempotent (冪等)」と表現している
        - 厳密な数学的定義とは異なるが、同じ入力に対して同じ出力を返す性質を指す
        - そのため、以後は 冪等な関数 という表現も用いる
      - この関数が A の性質を満たすためには、外部システムからの値の読み取りを避ける必要がある
        - ブラウザの APi の呼び出しによる値の読み取り
          - `document.title` 読み取り
        - fetch による外部サーバからのデータ取得
        - localStorage からのデータ取得
        - ランダム値の生成と読み取り
        - 現在時刻の読み取り
    - B. 関数の実行で外部の値を変更しない関数
      - 関数の実行によって、外部システムに影響を与える処理 を行わない関数
      - この関数が B の性質を満たすためには、外部システムへの値の書き込みを避ける必要がある
        - ブラウザの API の呼び出しによる値の変更
          - `document.title` の値変更
        - fetch による外部サーバへのデータ送信
        - localStorage へのデータ保存
        - 実 DOM ノード の直接操作
          - DOM ノードの直接操作とは、React の管轄外の操作であると言えるため
          - React 管轄外の外部システムに対する値の変更に該当する
        - 非 React の 命令的ライブラリ の初期化・破棄
        - その他、React 要素の生成に関係のない行為
          - `setTimeout` や `setInterval` のタイマー登録

  - A/B で禁止された処理は、おおむね「外部システム」とのやり取りに該当する
  - この外部システムとのやり取りに該当する処理を、React では「副作用」と呼ぶ
  - React は、関数がこの副作用を持たないことを強く推奨している
    - なお、「要素を生成する関数」である関数コンポーネントが副作用を持たない設計にすることを要求しているだけであり、
      - React で記述するアプリケーション全体に対して 一切の副作用を禁止しているわけではない
      - むしろ React は、副作用処理を記述する手段を提供している
      - 副作用を実行するための手段 は 別途 提供されている (後述)
  - なお、これ以降
    - state, props, context を まとめて 状態群 と呼ぶことにする

- 入力値 である 状態群 の値が変化した時に React が React 要素を生成しなおす仕組み
  - 関数コンポーネントは
    - 入力値 である state, props, context の組み合わせ (状態群) から
    - 純粋に React 要素 を生成する関数
  - React では、React 要素の生成関数も React が呼び出す
    - 開発者は、関数コンポーネントを定義し React に登録するだけで良い
    - 入力値である 状態群の いずれかの値が変化した時に
    - React 関数コンポーネントを呼び出し、
    - React 要素 を生成する
      - 余談: props の場合は props の値の変化を検知するというより、
      - 親コンポーネントが再レンダーされるタイミングで props は 「変化した」とみなされ、
      - 関数コンポーネントが再実行される
  - これにより、 UI の状態変化に応じた React 要素の更新が実現される
  - 入力 が 変化した際に それに反応して 出力 (React 要素) を 再生成 するという設計

- 入力値は スナップショット (イミュータブル) なデータとして扱う という設計思想
  - 関数コンポーネントの実行処理における 状態群 のイミュータブル性
    - 状態群 (state, props, context) は
      - 関数コンポーネント実行時に導出され、固定される
      - そのため、関数コンポーネントの実行の途中に、これらの値を即時に変化させることはできない
    - つまり、関数コンポーネント実行時における 状態群は
      - 関数コンポーネントの実行開始時に値が固定され、
      - 終了まで変化しない、イミュータブル (不変) なデータとして扱われる
  - スナップショット という考え方
    - スナップショット とは、
    - 「ある時点の状態を切り取った」イミュータブル (不変) なデータのこと
    - React は状態群に対して スナップショット という考え方を導入している
      - React においては、状態群 がスナップショットとして扱われ、
      - 一つのレンダーフェーズ (関数コンポーネントの実行) において、
      - 状態群の値が変化せず一貫して同じ状態が保たれることを保証している
  - 状態群 がスナップショットとして固定されることで
    - 1 つの関数コンポーネント実行中において、
    - 一貫して同じ状態が保たれることが保証され、レンダリングの予期しないバグを防止できる
  - 余談: スナップショット と バッチ処理の関連性
    - React は、状態群 をスナップショットとして扱うことで
    - 必然的に バッチ処理が要件として必要になってくる
    - 詳細は後述する
  - 余談: JS の仕組みから イミュータブルになっている訳ではない
    - state, props, context 自体は JS のオブジェクトであり、
      - JS の仕組み上は ミュータブル (可変) である
      - そのため、技術的には 状態群 の値を 変更することは可能である
    - しかし、React の設計思想として
      - 関数コンポーネント実行時における 状態群 は
      - スナップショット として扱われ、イミュータブル なデータとして扱われると想定されている
    - そのため、これらの値を 関数コンポーネント実行中に 変更することは React の設計思想に反する
      - 開発者は、これらの状態群の値を 変更するのを避け、
      - イミュータブル なデータとして 扱うように努める必要がある
